\newpage
\section{Controller Design}
Controlling the PMSM motor will be done using the principles of vector control, where the controller produces a change to the PWM inverter input. This is done by monitoring the two of the three current inputs to the motor and transforming them using the dq0 transform. This transform yields a d and q DC value and a zero, which are respectively referred to a torque demand and a flux demand. \newline

The requirement for this project outlines that the motor must be torque controlled, hence the flux demand will be a zero while the torque demand will be defined by the speeder pedal. After the dq values have been compared to the reference/demand values the error is fed to a PID controller which will adjust the output accordingly. This output is transformed using the inverse dq0 transform, which yields a three phase AC signal that can be fed into the inverter and yield a new motor speed. \newline

Ilustrating this, the block diagram presented in section 4 can be retrieved. Figure \ref{fig:control_process_sec8}. This shows how the ABC three phase AC values are retrived from the motor input, transformed to dq0 and then compared to reference values. The $i_d$ value will be zero as it is the flux reference, while the $i_q$ value will be set by the speeder pedal as a torque reference. The controller acts upon these and the dq values are transformed back to ABC three phase AC and fed to the inverter.

In reality it is not a torque value that must be a reference for the controller, but a current value, as the current determines the torque. Taking this into account will be part of creating a functional model of the motor.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth,trim=0cm 4cm 0cm 2cm]{graphics/block_diagram}
	\caption{The control process as illustrated in the system overview section}
	\label{fig:control_process_sec8}
\end{figure}

\todo[inline]{MORTEN: have to change picture to have the correct signs and values compared to the stuff below. must be a little more scientific than it is now. Ask me! - will do it myself! i got le visio installed}

To properly control this, a model of the PMSM motor is required to derive controller values for the two PID controllers. To model the PMSM motor an equivalent circuit of the motor will be used. Figures \ref{fig:PMSM_Equivalent_d_axis} and \ref{fig:PMSM_Equivalent_q_axis} shows these circuits for the d and q axes. These equivalent circuits are based on the motor presented in section 7 and use dq0 to represent the two DC phases that are controlled. \newline

The figures show that there are common component values between the two circuits which are the values directly from the motor. The other equivalent values are of less concern which is apparent from the next diagram, figure \ref{fig:State_space_model1}.

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/d_axis_equivalent}
		\caption{PMSM motor equivalent circuit, d-axis}
		\label{fig:PMSM_Equivalent_d_axis}
	\end{subfigure}
	\hspace{1cm}
	\begin{subfigure}[t]{.28\linewidth}
		\includegraphics[width=\textwidth]{graphics/q_axis_equivalent}
		\caption{PMSM motor equivalent circuit, q-axis}
		\label{fig:PMSM_Equivalent_q_axis}
	\end{subfigure}
	\caption{Source: http://goo.gl/EM8LoN}
\end{figure}

\todo{Morten: add source to cites}




\subsection{State Space Model}
A state space model is derived from the physical representation of a PMSM motor, figure \ref{fig:State_space_model1}, consisting of an electrical part on the left and a mechanical part on the right side of the model. The model is made in MatLab Simulink. The model is very similar to that of a DC motor when interpreted like this.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model1}
	\caption{PMSM motor state space model.}
	\label{fig:State_space_model1}
\end{figure}

Reducing this model to use transfer functions for the electrical and mechanical parts results in a more simple model, figure \ref{fig:State_space_model2}. A wind resistance has been added to show how it affects the torque of the motor. The value of the wind resistance is the rotational speed squared multiplied by a drag value. This value will be a negative number, which is then added to the torque output to slow down the motor. The drag can be approximated by looking at the gearings of the kart and the motors own drag coefficient.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model2}
	\caption{PMSM motor model simplified with tranfer functions.}
	\label{fig:State_space_model2}
\end{figure}

An even further reduced model is derived to further simplify the system. This model removes torque load, friction and wind resistance. It is shows on figure \ref{fig:State_space_model3}. This model can be used to find controller values if the torque load, viscous friction and wind resistance are all seen as disturbances. The controller should be able to handle the about of disturbance that can be found in these values.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model3}
	\caption{PMSM motor model without torque load, friction and wind resistance.}
	\label{fig:State_space_model3}
\end{figure}

\subsection{Controlling Current}
The motor must be current controlled in order to limit the torque. If the motor was speed controlled, as is often used in motor control, it could demand a much higher current than possible by the circuit, requiring a limiter on the current input instead, or otherwise it could result in destroying the drive circuit. A current control also means that the speeder pedal will be a current reference, translating into a torque reference, resulting in an even motor speed even if the kart is driving on a uneven plane such as a hill.

A control loop is added to the model, figure \ref{fig:State_space_model4}. It must be current controlled to control the torque. This means that a feedback loop is added from inside the motor back to the controller. 

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model4}
	\caption{PMSM motor model with a current control loop.}
	\label{fig:State_space_model4}
\end{figure}


\subsection{Transfer Function}
The model of figure \ref{fig:State_space_model4} can be rearranged to simplify the transfer function. This rearrangement can be seen on figure \ref{fig:State_space_model5}. Here the current is the output, a current reference is the input, and the mechanical part of the motor is all placed into a feedback loop.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model5}
	\caption{PMSM motor model rearranged to simplify the transfer function.}
	\label{fig:State_space_model5}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/State_space_model6}
	\caption{PMSM motor model as a plant with PI control}
	\label{fig:State_space_model6}
\end{figure}

Using masons rule \todo{Morten: dodds book reference to masons} the transfer function can be derived. Seeing the control loop as a controller and a plant the following equation is achieved. Equation \ref{eq:plant_masons}.

\begin{equation}
\frac{I_m}{I_{ref}}= \frac{(K_p+K_i\frac{1}{s})G(s)}{1-(K_p+K_i \frac{1}{s})G(s)}
\label{eq:plant_masons}
\end{equation}

Replacing $G(s)$ and rearranging to get the form of a characteristics equation the transfer function is equation \ref{eq:transfer_function_full}.
\begin{equation}
\frac{I_m}{I_{ref}}=\frac{s^2\frac{K_p}{L}+s(\frac{K_i}{L}+\frac{K_pK_v}{J})+\frac{K_iK_v}{J_r}}{s^3+s^2(\frac{R}{2L}+\frac{K_v}{J}+\frac{K_p}{L})+s(\frac{3K_t^2}{2JL}+\frac{K_vR}{JL}+\frac{K_i}{L}+\frac{K_pK_v}{2J})+\frac{K_iK_v}{J}}
\label{eq:transfer_function_full}
\end{equation}

This third order transfer function will be used to derive the controller values.

\subsection{Controller Values}
To find the controller values the Stephen Dodds Settling Time Formula for $5\%$ settling time is used. The desired characteristics polynomial of a transfer function for the settling time formula to work is

\begin{equation}
s^n+d_{n-1}s^{n-1}+\cdot \cdot \cdot +d_1s+d_0
\end{equation}

The d's of a given order can be looked up in Stephen J. Dodds' book \todo{cite book} on page 850.

This yields the following third order equation for a third order system.

\begin{equation}
s^3 + 3\alpha s^2+3\alpha^2s+\alpha^3
\end{equation}

Based on the transfer function in equation ref and a settling time of 0.1 seconds, alpha will be defined by the following equation. This value is used to find the Kp and Ki values for the controller.

\begin{equation}
\alpha=\frac{1.5(1+n)}{T_s^{5\%}}=\frac{6}{0.1}=60
\label{eq:Dodds_settlingtime}
\end{equation}

Finding the controller values.

\begin{equation}
3 \alpha= \frac{R}{2L}+ \frac{K_v}{J}+ \frac{K_p}{L} \rightarrow K_p=(3 \alpha - \frac{K_v}{J}- \frac{R}{2L})L
\end{equation}
\begin{equation}
3 \alpha^2= \frac{2K_t^2}{2JL}+ \frac{K_vR}{JL}+ \frac{K_i}{L}+ \frac{K_pK_v}{2J} \rightarrow K_i=(3 \alpha^2- \frac{K_pK_v}{2J}- \frac{K_vR}{JL}- \frac{3K_t^2}{2JL})L
\end{equation}

These equations yield the following controller values, equation \ref{eq:Kpvalue} and \ref{eq:Kivalue}.
\begin{equation}
K_p=0.0039
\label{eq:Kpvalue}
\end{equation}
\begin{equation}
K_i=0.4606
\label{eq:Kivalue}
\end{equation}

\subsection{Simulation}
Testing the $K_p$ and $K_i$ values should result in a stable current output from the electrical part of the motor, which is desired to control the torque. This simulation will add the $K_p$ and $K_i$ values to the control loop and review the outcome.



\clearpage