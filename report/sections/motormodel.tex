%!TEX root = ../main.tex
\newpage
\section{Controller Design}\label{sec:controller_design}
Controlling the PMAC motor will be done using the principles of field oriented control, which uses the Clarke Park Transform (dq0 transform) to transform three phase AC into two phase DC for much easier regulation. Controlling the PMAC motor is done by producing a change to the PWM inverter input. This is done by monitoring two of the three current inputs to the motor and transforming them using the dq0 transform. \newline


The Clarke Park transform is integral to the type of control desired for the PMAC motor, so it must be understood. It is done by 'transforming the stator currents into a rotating reference frame that is locked to the rotation of the rotor' (\cite{electric_motor_and_drives} p.221). The transform starts by viewing the three phase star connection of the PMAC motor and displaying each phase as ABC (or W U and V as seen on figure \ref{fig:dq_transform_ref_frames} from the book cited \cite{electric_motor_and_drives}). This ABC current is first transform into a stationary frame of only two phases called the $\alpha \beta$ \todo{along horizontal and vertial axes of the three phase stationary windings}transform\todo{ed} and then further transformed into dq0\todo{zero isn't necessary for a balanced load, and if it's not mentioned in alpha beta, it should not be mentioned here.}. When in dq0 form the \todo{what?}reference frame rotates with the angular velocity $\omega$ of the motor, while being referenced to the stationary frame of the $\alpha \beta$ frame. This transform yields a d and q DC value and a zero, which are respectively referred to a torque and a flux demand in the controller.\newline

\todo{clarke park transformation can only be done for current, voltage and flux linkage.}

\begin{figure}[H]
	\centering
	\includegraphics[width=.65\linewidth]{graphics/ABC_to_dq_ref_frame}
	\caption{Clarke Park Transform reference frames. Source: \cite{electric_motor_and_drives}}
	\label{fig:dq_transform_ref_frames}
\end{figure}

Clarke-park:
\begin{equation}
\left[ \begin{array}{c}
I_d \\ I_q
\end{array} \right]
=
\frac{2}{3}
\begin{bmatrix}
\cos (\Phi) & \cos(\Phi - \gamma) & \cos( \Phi + \gamma) \\
-\sin (\Phi) & -\sin(\Phi - \gamma) & -\sin( \Phi + \gamma)
\end{bmatrix}
\cdot
\begin{bmatrix}
I_A \\
I_B \\
I_C
\end{bmatrix}
%\label{eq:sim_clark-park}
\end{equation}

where $\gamma = \tfrac{2 \pi}{3}$. 

inverse clarke-park:

Inverse Clark-Park transformation is done by equation~\ref{eq:sim_inverse_clark-park}.

\begin{equation}
\left[ \begin{array}{c}
I_A \\ I_B \\I_C
\end{array} \right]
=
\begin{bmatrix}
\cos (\Phi) & -\sin (\Phi) \\
\cos(\Phi - \gamma) & -\sin(\Phi - \gamma) \\
\cos(\Phi + \gamma) & -\sin( \Phi + \gamma) 
\end{bmatrix}
\cdot
\begin{bmatrix}
I_d \\
I_q
\end{bmatrix}
%\label{eq:sim_inverse_clark-park}
\end{equation}

The requirement for this project outlines that the motor must be torque controlled, hence the flux demand will be zero while the torque demand will be defined by the speeder pedal. After the dq values have been compared to the reference/demand values the error is fed to a controller which will adjust the output accordingly. This output is transformed using the inverse dq0 transform, which yields a three phase AC signal that can be fed into the inverter and yield a new motor speed. \newline

Illustrating this, the block diagram presented in section 4 can be retrieved. Figure \ref{fig:control_process_sec8}. This shows how the current of the three phase AC values are retrieved from the motor input, transformed to dq0 and then compared to reference values. The $i_d$ value will be zero as it is the flux reference, while the $i_q$ value will be set by the speeder pedal as a torque reference. The controller acts upon these and the dq values are transformed back to ABC three phase AC and fed to the inverter.

In reality it is not a torque value that must be a reference for the controller, but a current value, as the current determines the torque. Taking this into account will be part of creating a functional model of the motor.

\begin{figure}[H]
	\centering
	\includegraphics[width=1\linewidth]{graphics/ContolProcessDiagram}
	\caption{The control process as illustrated in the system overview section}
	\label{fig:control_process_sec8}
\end{figure}

To properly control this, a mathematical model of the PMAC motor from section 7 is required to derive controller values for the two controllers labelled "$I_q$ Controller" and "$I_d$ Controller" in figure \ref{fig:control_process_sec8}. To model the PMAC motor an equivalent circuit of the motor will be used. For an AC electrical motor the equivalent circuit can be represented by the diagram presented on figure \ref{fig:PMSM_Equivalent_d_axis} and \ref{fig:PMSM_Equivalent_q_axis}.\newline

These figures show that the PMAC motor can be represented as an electrical diagram with the physical properties represented by inductors and resistors. The connection between the rotor and stator works like a transformer, with coils generating a change in either part to represent the stator to rotor relation. The coils on the rotor move with respect to those on the stator, so there is a variation in the amount of movement between them, which is important for the generation of torque. The circuit is split into two parts, one for the torque and one for the flux. Which is exactly what is done through the dq0 transform. \newline

\begin{figure}[!h]
	\centering
	\begin{subfigure}[t]{.5\linewidth}
		\includegraphics[width=\textwidth]{graphics/d_axis_equivalent}
		\caption{PMAC motor equivalent circuit, d-axis}
		\label{fig:PMSM_Equivalent_d_axis}
	\end{subfigure}
	\hspace{1cm}
	\begin{subfigure}[t]{.30\linewidth}
		\includegraphics[width=\textwidth]{graphics/q_axis_equivalent}
		\caption{PMAC motor equivalent circuit, q-axis}
		\label{fig:PMSM_Equivalent_q_axis}
	\end{subfigure}
	\caption{PMAC Motor $I_d $ and $I_q$ equivalent diagrams.\cite{pmac_equivalent_diagram}}
\end{figure}

The components shown are: the mutual inductance $l_s$, $L_{md}$ and $L_{mq}$. Armature resistance $R_s$ and flux leakage for both d and q axes. The most important values here are the q-axis inductor and resistance which directly affect how much torque is gained from inputting current to the PMAC motor. During this section the components above will be named as follows.

\begin{equation}
R_{sq}=R_a, \quad L_{md}+L_{mq}=L_a=L_q \quad 
\end{equation}

Another thing that can be learned from this electrical equivalent diagram is that the magnet on the rotor side, on the d-axis diagram figure \ref{fig:PMSM_Equivalent_d_axis}, can be seen as a current source $i_m$. A change in flux of this magnet will induce a force resulting in current in the magnet. This is shown with the $R_m$ resistor. Through this it is apparent that the d-axis is the flux part of the motor, while q is the current.

To current control the motor, the model and controller will be developed for the q-axis of this equivalent diagram. The q-axis by itself resembles the equivalent circuit of a DC motor very much and this can be used to design a mathematical model of the motor.

\subsection{State Space Model}
A state space model is derived from the physical representation of a PMAC motor, figure \ref{fig:State_space_model1}, consisting of an electrical part on the left and a mechanical part on the right side of the model. The model is made in MatLab Simulink. The model is very similar to that of a DC motor when interpreted like this.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/full_order_with_resistances_to_pdf}
	\caption{PMAC motor state space model.}
	\label{fig:State_space_model1}
\end{figure}

Reducing the model of figure \ref{fig:State_space_model1} to use transfer functions for the electrical and mechanical parts results in a more simple model with fewer loops. It is shown on figure \ref{fig:State_space_model3}. 
%It can be used to find controller values if the torque load and wind resistance are seen as outside disturbances. The controller should be able to handle the amount of disturbance that can be found in these values. The wind resistance will get proportionally larger the faster the kart is moving, but for this first model it will not be taken into account. 
In the electric part of the circuit a new value $TS$ has been added to the denominator of the transfer function, this value is the electromagnetic time constant of the stator, defined as $TS=L_a/R_a$. The constant defined $J_{pro}$ is the projected inertia of the kart, based on the expected weight with a driver and also adding the inertia of each gearing cog.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/full_order_as_tf_without_resistances_to_pdf}
	\caption{Transfer function PMAC motor model.}
	\label{fig:State_space_model3}
\end{figure}

\subsubsection{No Inductor Model}
The model from figure \ref{fig:State_space_model1} can be reduced by removing the inductance completely, this yields a model of reduced order. Reducing the order results in a model that can be easier to derive a controller for, because it removes a pole from the system. 
%The assumption here is that the inductor and integrators result in a very fast pole, that will be too fast to really affect the system. Whether this is a correct assumption will be tested with a simulation of either model. 
This reduced order model is seen on figure \ref{fig:State_space_model_reduced_order}.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/electrical_reduced_order_to_pdf}
	\caption{Reduced order PMAC motor model.}
	\label{fig:State_space_model_reduced_order}
\end{figure}

A pole-zero map of both models will be used to see whether the inductor can be removed without affecting the system significantly. Figure \ref{fig:PZmap_full} and \ref{fig:PZmap_Reduced} show this. 

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/full_order_model_pz_map}
		\caption{PZ map of full order model}
		\label{fig:PZmap_full}
	\end{subfigure}
	\hspace{0.5cm}
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/reduced_order_model_pz_map}
		\caption{PZ map of no inductor model}
		\label{fig:PZmap_Reduced}
	\end{subfigure}
	\caption{Matlab Simulink PZ Map of each model}
\end{figure}

The pole-zero plot shows that the inductor pole is much faster than the mechanical pole, so it should be possible to remove it. \newline

The two state space models will be simulated with MatLab Simulink to see how much the system is affected by the removal of the inductor. This will be shown by applying a constant voltage of $26.2V$ and then monitoring the results in both current output and angular velocity. Figure \ref{fig:Full_Vs_Reduced1_Current} and \ref{fig:Full_Vs_Reduced1_Speed} show these simulations.
\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/Full_Vs_Reduced1_Current}
		\caption{Simulation of current for full and no inductor model.}
		\label{fig:Full_Vs_Reduced1_Current}
	\end{subfigure}
	\hspace{0.5cm}
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/Full_Vs_Reduced1_Speed}
		\caption{Simulation of speed for full and no inductor models (almost stacked on each other).}
		\label{fig:Full_Vs_Reduced1_Speed}
	\end{subfigure}
	\caption{Matlab simulation of each model with the same input}
\end{figure}

 A problem shows up by these simulations. The speed looks fine for the no inductor model but the current starts at a high value. The current starts out as a simple multiplication of the input voltage multiplied by the $1/R$ gain to equal $4000A$. The amplitude of speed and current are not important at this time, as that will be controlled later, but since the model does not ramp up the current like the  full order model, a controller will not be derived for this reduced order model.

\subsubsection{Reduced Order Model - No Mechanical Part}
\label{sec:reduced_model_1}
Because of the problem with reducing the model by removing the inductor, this section will focus on reducing the order by removing the mechanical part. This model will be an experiment to remove the slow pole from the full order model. This will affect the system significantly. The mechanical system will now be seen as a disturbance. It can be seen on figure \ref{fig:State_space_model_reduced_order_v2}.

\begin{figure}[H]
	\centering
	\includegraphics[width=.55\linewidth]{graphics/mechanical_reduced_order_to_pdf}
	\caption{Reduced order PMAC motor model version}
	\label{fig:State_space_model_reduced_order_v2}
\end{figure}

The model is basically an LR circuit where the output is the current. Which will just go as high as the L and R allows and stay there, since the back emf is not included. 
%A PZ map should shows that the slow pole to the right is removed. Figure \ref{fig:PZmap_reduced_v2} shows the result.
%\begin{figure}[H]
%	\centering
%	\includegraphics[width=.55\linewidth]{graphics/reduced_order_model_v2_pz_map}
%	\caption{PZ map of the reduced order model version 2}
%	\label{fig:PZmap_reduced_v2}
%\end{figure}

%The slow pole is gone, this is an important pole for the system, so removing it will be influential in the output. It  
%it is as slow as it is, so it might not be a good idea to remove it. The current must be controlled so leaving out all the m

% The removal of the pole requires the controller to be fast enough to react to subtle changes in the torque pedal, and robust because overshoot and steady state error should be intolerable, it should be able to handle all the mechanicals as a disturbance, but that might not be a possible outcome. 
Figure \ref{fig:Full_Vs_Reduced2} shows the current.

\begin{figure}[H]
	\centering
	\includegraphics[width=.55\linewidth]{graphics/Full_Vs_Reduced2_Current}
	\caption{Full order vs reduced order model}
	\label{fig:Full_Vs_Reduced2}
\end{figure}

This shows that the current ramps up and stays there. The current starts at zero and ramps up. The downward slope of the full order model is caused by the back emf which is removed in the reduced model.
%
%This model could be used with a controller, but will require some simulations with the motor after a controller has been developed, the downward slope of the full order model is caused by the mechanical system getting saturated by current, this should not change how each model is affected by current control, because a fast and robust controller is desired.

\subsection{Controlling Current}
The motor must be current controlled in order to control the torque. 
%If the motor was speed controlled, as is often used in motor control, it could demand a much higher current than possible by the circuit, requiring a limiter on the current input instead, or in worst case it could result in destroying the drive circuit. A current control also means that
The torque pedal is used as the reference for the current controller, thus indirectly controlling the torque. 

A control loop is added to the model of figure \ref{fig:State_space_model3}. This means that a feedback loop is added from inside the motor model and fed back to the controller. On figure \ref{fig:State_space_model4} it is shown with the full order system.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/full_order_as_tf_with_controller_to_pdf}
	\caption{Full PMAC motor model with a current control loop.}
	\label{fig:State_space_model4}
\end{figure}

It would be preferable to have a second order controller for a second order system but the PI itself is preferred to avoid using a derivative in the discretized controller. A derivative term can become very inaccurate at high frequency. To improve precision it must be slowed down, but then the controller might be too slow all together. Hence if the derivative term can be avoided it will be. It should be able to control the 2nd order system based on the fact that one of the poles are very fast. The following sections will determine how well the PI controller can control the system.


\subsection{Controlling the Full Order System}
The model of figure \ref{fig:State_space_model4} can be rearranged to simplify the transfer function. This rearrangement can be seen on figure \ref{fig:State_space_model5}. Here the current is the output, a current reference is the input, and the mechanical part of the motor is all placed into a feedback loop. This reduces the complexity of the overall transfer function to only be a plant model with a PI controller added as shown in figure \ref{fig:State_space_model6}.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/full_order_rearranged_to_pdf}
	\caption{PMAC motor model rearranged to simplify the transfer function.}
	\label{fig:State_space_model5}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/plant_with_pi_to_pdf}
	\caption{PMAC motor model as a plant with PI control}
	\label{fig:State_space_model6}
\end{figure}

Using 'Masons Rule'\cite{feedback}, the transfer function can be derived. The following equation is achieved:

\begin{equation}
\dfrac{I_q}{I_{q_{ref}}}= \dfrac{(K_p+K_i\frac{1}{s})G(s)}{1+G(s)(K_p+K_i \frac{1}{s})}
\label{eq:plant_masons}
\end{equation}

$G(s)$ from figure \ref{fig:State_space_model1} is:

\begin{equation}
G(s)=\frac{2 J_{pro} s + 2 K_v}{s^2(2 J_{pro} L_a) + s(2 K_v L_a + 2 J_{pro} R_a)+3 K_t^2 + 2K_v R_a}
\label{eq:full_order_tf}
\end{equation}

%Analysing this transfer function it can be seen that we have a second order system, with possibly one zero and one or two poles. The zero will be located at the root of the nominator: $2J_{pro}s+2K_v=0 \rightarrow s=\frac{-K_v}{J_{pro}}$. Which will probably be a very small real number, as inertia should be much larger than the viscous friction. 
%The pole(s) will be located at the roots of the denominator.
 The denominator can be reduced by dividing everything with $2J_{pro}L_a$. yielding the transfer function in equation \ref{eq:big_guy_huh}.

\begin{equation}
G(s)=\frac{\frac{1}{L_a}s+\frac{K_v}{J_{pro}}}{
s^2+s \left( \frac{K_v}{J_{pro}}+\frac{R_a}{L_a} \right) +\frac{3}{2}\frac{K_t^2}{J_{pro}L_a}+\frac{K_vR_a}{J_{pro}L_a}}
\label{eq:big_guy_huh}
\end{equation}

%Based on the form of the denominator being a second order equation, there could be complex conjugate poles. This cannot be known until all values are inserted and the roots of the denominator found. This means that it could have any number of characteristic. The pole-zero map with the values included was used in figure \ref{fig:PZmap_full}.
% Two poles on the real axis and a zero close to the imaginary axes mean that the system is stable with decay. \newline

Inserting \ref{eq:big_guy_huh} in \ref{eq:plant_masons} and rearranging to get the form of a characteristics equation the transfer function is equation \ref{eq:transfer_function_full}.

%old equation. please leave (Morten)
\begin{equation}
\frac{I_q}{I_{q_{ref}}}=\frac{s^2\frac{K_p}{L_a}+s(\frac{K_i}{L_a}+\frac{K_pK_v}{J_{pro}})+\frac{K_iK_v}{J_{pro}}}{s^3+s^2(\frac{R_a}{2L_a}+\frac{K_v}{J_{pro}}+\frac{K_p}{L_a})+s(\frac{3K_t^2}{2J_{pro}L_a}+\frac{K_vR_a}{J_{pro}L_a}+\frac{K_i}{L_a}+\frac{K_pK_v}{J_{pro}L_a})+\frac{K_iK_v}{J_{pro}L_a}}
\label{eq:transfer_function_full}
\end{equation}


%2nd order transfer function: dont delete
%\begin{equation}
%\dfrac{I_m}{I_{ref}}=\dfrac{L_a(K_i+K_ps)}{s^2+s(\frac{R_a}{L_a}+\frac{1}{L_a}K_p)+\frac{1}{L_a}K_i+\frac{3K_t^2}{2JL_a}}
%\label{eq:transfer_function_full2}
%\end{equation}

This third order transfer function will be used to derive the controller values.

\subsection{Full Order Controller Values}\label{sub:full_order_controller_values}
To find the controller values the Stephen Dodds Settling Time Formula for $5\%$ settling time is used\cite{feedback}, The desired characteristics polynomial of a transfer function for the settling time formula to work is equation \ref{eq:char_eq_wanted}.

\begin{equation}
s^n+d_{n-1}s^{n-1}+\cdot \cdot \cdot +d_1s+d_0
\label{eq:char_eq_wanted}
\end{equation}

The d's of a given order can be derived by solving $(s+d)^n$ 
for the given order of the characteristics equation.
This yields the following third order equation for a third order system.

\begin{equation}
s^3+3\alpha s^2+3\alpha^2s+\alpha^3
\label{eq:s_form_equation}
\end{equation}

Based on the transfer function in equation \ref{eq:transfer_function_full} and a settling time of 0.05 seconds, $\alpha$ will be defined by the following equation:

\begin{equation}
\alpha=\frac{1.5(1+n)}{T_s^{5\%}}=\frac{6}{0.05}=120
\label{eq:Dodds_settlingtime}
\end{equation}

Characteristics equation of \ref{eq:full_order_tf} is equation \ref{eq:big_guy_with_cont}.

\begin{equation}
s^3+s^2\left(\frac{R_a}{2L_a}+\frac{K_v}{J_{pro}}+\frac{K_p}{L_a}\right)+s\left( \frac{3K_t^2}{2J_{pro}L_a}+\frac{K_vR}{J_{pro}L_a}+\frac{K_i}{L_a}+\frac{K_pK_v}{J_{pro}L_a}\right)+\frac{K_iK_v}{J_{pro}L_a}
\label{eq:big_guy_with_cont}
\end{equation}

Grouping constants yields the following form:

\begin{equation}
s^3+s^2(a_2+b_2K_p)+s(a_1+b_1K_i)+a_0+b_0
\end{equation}

Setting this equation equal to \ref{eq:s_form_equation} yields:

%%%Morten: These calculations are for the reduced order model (v1). please leave until complete.
%\begin{align}
%a_2&=\frac{K_v}{J_m}+\frac{R_a}{L_a}  &b_2&=\frac{1}{L_a}\nonumber\\
%a_1&=\frac{K_vR_a}{J_mL_a}+\frac{3}{2}\frac{K_t^2}{J_mL_a} &b_1&=\frac{1}{L_a}+\frac{K_pK_v}{J_mL_a}\nonumber\\
%a_ 0&=0  &b_0&=\frac{K_v}{J_mL_a}\nonumber
%\end{align}




\begin{equation}
s^3+s^2(a_2+b_2K_p)+s(a_1+b_1K_i)+a_0+b_0 = s^3+3\alpha s^2+3\alpha^2s+\alpha^3
\label{eq:doddsnormaleq}
\end{equation}

Solving the above equation for $K_p$ and $K_i$ yields the equation two equations \ref{eq:solved_d1} and \ref{eq:solved_d2}.
%Old calculations of kp=0.0039 and Ki=0.4606. please leave it.
%\begin{equation}
%3 \alpha= \frac{R_a}{2L_a}+ \frac{K_v}{J_{pro}}+ \frac{K_p}{L_a}
%\label{eq:solved_d1}
%\end{equation}
\begin{equation}
K_p=(3 \alpha - \frac{K_v}{J_{pro}}- \frac{R_a}{2L_a})L_a
\end{equation}\newline
%\begin{equation}
%3 \alpha^2= \frac{2K_t^2}{2J_{pro}L_a}+ \frac{K_vR_a}{J_{pro}L_a}+ \frac{K_i}{L_a}+ \frac{K_pK_v}{2J_{pro}}
%\label{eq:solved_d2}
%\end{equation}
\begin{equation}
K_i=(3 \alpha^2- \frac{K_pK_v}{2J_{pro}}- \frac{K_vR}{J_{pro}L_a}- \frac{3K_t^2}{2J_{pro}L_a})L_a
\end{equation}


%%Morten: Calculations from reduced order transfer function that does not work.
%From equation \ref{eq:doddsnormaleq}, the following equations can be made:
%\begin{equation}
%a_2+b_2K_p=d_2 \rightarrow K_p\frac{d_2-a_2}{b_2}
%\end{equation}
%
%\begin{equation}
%a_1+b_1K_i=d_1 \rightarrow K_i\frac{d_1-a_1}{b_1}
%\end{equation}

These equations yield the following controller values when inserting the known motor parameters:

\begin{equation}
K_p=0.0111
\label{eq:Kpvalue}
\end{equation}
\begin{equation}
K_i=1.7566
\label{eq:Kivalue}
\end{equation}

The pole-zero map for the transfer function including the controller confirms that a new pole and zero has been added. All poles and zeroes lie on the real axis, meaning they affect the system by altering the decay while no oscillation is introduced. The system is stable with these values since they are all on the left side of the imaginary axis. See figure \ref{fig:PZmap_Control_full}. How the controller affects the output will be tested further on.

\begin{figure}[H]
	\centering
	\includegraphics[width=.55\linewidth]{graphics/full_order_w_pid_to_pdf}
	\caption{PZ map with the controller}
	\label{fig:PZmap_Control_full}
\end{figure}


\subsection{Controller for the Reduced Transfer Function}
In section \ref{sec:reduced_model_1} a reduced order model of the PMAC motor was derived. This model removed the mechanical part of the model to reduce the order. This section will develop a controller for this model.

The same procedure as for the full order system will be used for this transfer function. The open loop transfer function is equation \ref{eq:small_trans}.

\begin{equation}
\frac{I_q}{V_{in}}=H(s)=\frac{1}{R_a+L_as}
\label{eq:small_trans}
\end{equation}

%There are no zeros as the numerator has no s values and there is one real pole at $R_a+L_as=0 \rightarrow s=0$. Which equals to (0,0) in the pole-zero map. This means that as the gain increases this pole becomes faster and faster (moves to the left). With the pole right on the imaginary axis the transfer function itself is marginally damped, and will be stable by itself. It is basically a constant value determined by the initial conditions. The controller is still needed to set a reference value though. With no mechanical part there is no decay at all, but a test will have to be performed to see how well a controller can react to the disturbance of the mechanical part.

\subsection{Reduced Order Controller Values}\label{sub:reduced_order_controller_values}
Finding the controller values for this model is done as it was for the full order model. However an IP controller will be used instead to avoid adding a zero to the transfer function.

 The IP controller places the $K_p$ value in a feedback loop resulting in the following diagram on figure \ref{fig:IPcontroller1}.

\begin{figure}[H]
	\centering
	\includegraphics[width=.95\linewidth]{graphics/plant_with_ip_to_pdf}
	\caption{Reduced order system with an IP controller}
	\label{fig:IPcontroller1}
\end{figure}

The closed loop transfer function of figure \ref{fig:IPcontroller1} is:
\begin{equation}
\frac{I_q}{I_{qref}}=\frac{\frac{K_t}{L_a}}{s^2+s(\frac{R_a}{L_a}+\frac{K_p}{L_a})+\frac{K_t}{L_a}}
\label{eq:trans_reduced1}
\end{equation}

Using Dodd's $5\%$ settling time formula\cite{feedback} and solving for a 2nd order system and a settling time of $0.05s$. The results are equation \ref{eq:sett_time_eq}
\begin{equation}
\alpha=\frac{1.5(1+2)}{0.05}=90
\label{eq:sett_time_eq}
\end{equation}

The desired characteristics equation has the form of the following equation (\ref{eq:char_eq_reduced1}).
\begin{equation}
s^2+sd_1+d_0 = s^2+2 \alpha s+ \alpha^2
\label{eq:char_eq_reduced1}
\end{equation}

Solving for $K_p$ and $K_p$ and inserting the known motor parameters yields the following controller values:
\begin{equation}
2 \alpha =\frac{R_a}{L_a}+\frac{K_p}{L_a} \rightarrow K_p=7e^{-4}
\label{eq:Kp_redux}
\end{equation}
\begin{equation}
\alpha^2=\frac{K_i}{L_a} \rightarrow K_i=0.324
\label{eq:Ki_redux}
\end{equation}

The closed loop transfer function results in the pzmap of figure \ref{fig:PZmapIPcontroller1}. Since there are no zero in the transfer function, there wont be one when adding an IP controller. The added pole becomes a complex conjugate pair. This means that the system is stable but might have oscillation. This will be tested in a simulation in the next section.

\begin{figure}[H]
	\centering
	\includegraphics[width=.55\linewidth]{graphics/reduced_order_model_w_ip_controller_to_pdf}
	\caption{PZ map of the reduced order system with an IP controller}
	\label{fig:PZmapIPcontroller1}
\end{figure}


\subsection{Control Simulation}
The derivations above have resulted in controller gain values as seen in table \ref{tab:cont_gains}.

\begin{table}[H]
\centering
\caption{Table of controller gains}
\label{my-label}
\begin{tabular}{lllll}
\cline{1-3}
\multicolumn{1}{|l|}{Model/Gain} & \multicolumn{1}{l|}{$K_p$} & \multicolumn{1}{l|}{$K_i$} &  &  \\ \cline{1-3}

\multicolumn{1}{|l|}{Full Order} & \multicolumn{1}{l|}{0.0111} & \multicolumn{1}{l|}{1.7566} &  &  \\ \cline{1-3}

\multicolumn{1}{|l|}{Reduced Order} & \multicolumn{1}{l|}{$7e^{-4}$} & \multicolumn{1}{l|}{0.324} &  &  \\ \cline{1-3}

                       &                       &                       &  & 
\label{tab:cont_gains}
\end{tabular}
\end{table}


The controllers should produce a stable current output from the electrical part of the motor, which is desired to control the torque.

Figure \ref{fig:Input_ref} is the input reference signal which simulates the torque pedal being fully actuated, then held for a few seconds and then released over two seconds. Full actuation is set to $300\si{\ampere}$ and the run time is set to 10\si{\second}.

\begin{figure}[H]
	\centering
	\includegraphics[width=.50\linewidth]{graphics/Control_signal_input}
	\caption{Input reference for the controller}
	\label{fig:Input_ref}
\end{figure}

Figure \ref{fig:output_both} shows how both models perform with the controller values found above and the input signal. The full order model has a small steady state error of slightly less than $5A$ while the reduced order model is spot on. The settling time for both is higher than the $0.05$ value set for the settling time formula though. The full order model settles in $0.9s$ while the reduced model settles is $0.13s$. They both handle the control as they should, with no overshoot at the start, or undershoot at the end of the breaking.

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/Controlled_response_Fullorder}
		\caption{Current output response of the full order model to the signal input given in figure \ref{fig:Input_ref}}
		\label{fig:Output_Full}
	\end{subfigure}
	\hspace{0.5cm}
	\begin{subfigure}[t]{.45\linewidth}
		\includegraphics[width=\textwidth]{graphics/Controlled_response_LR}
		\caption{Current output response of LC model to the signal input given in figure \ref{fig:Input_ref}}
		\label{fig:Output_LC}
	\end{subfigure}
	\caption{Simulations of each model with their controllers}
	\label{fig:output_both}
\end{figure}

The controller to be used for the kart will be determined by running a more in depth simulation in the next section, this simulation will include the physical systems, breaks, torque etc. A choice will be made based on controller performance in these tests.


\subsection{Discretization}
<<<<<<< HEAD
Discretizing the controller is required to use it in the embedded software. This is because the digital world of computers does not function in the same continuous form as the physical world. Everything is based on clock cycles and bits. So to make a controller function it must compute the integral based on calculations performed on a per clock basis. 
\todo[inline]{Morten: above is new. please read ty! :)}
To do this, the values of $K_p$ and $K_i$ can be used as they are, but for both a PI and IP controller the integrator must be discretized. An integrator in discrete is done by using a numerical integration method. The choice here will be the Trapezoidal method, which has the output equation given as equation \ref{eq:trap_integrat}. 
=======
Discretizing the controller is required to use it in the software. To do this, the values of $K_p$ and $K_i$ can be used as they are, but for both a PI and IP controller the integrator must be discretized. An integrator in discrete is done by using a numerical integration method. The choice here will be the Trapezoidal method, which has the output equation given as equation \ref{eq:trap_integrat}. 
>>>>>>> bc6adc466200d3cf249f4d577c821890b638706c

\begin{equation}
y_{n+1} = y_{n} + \frac{1}{2}h \left( f(t_n,y_n)+f(t_{n+1},y_{n+1}) \right)
\label{eq:trap_integrat}
\end{equation}

Here n is the time step, t is the time and y is the function to integrate. The trapezoidal method yields a more precise method than forward or backwards Euler methods, due to it being 2nd order precise ($O(h^2)$), but it takes twice the computation power.

\subsection{Third Harmonic Injection}
To utialize the voltage range of the power supply better, it was decided to use third harmonic injection.
Adding a $\frac{1}{6}$ of the third harmonic will result in 15 \% more line to line voltage. 
The resulting waveforms can be seen in section \ref{sec:Simulations}.
Studies of literature \cite{third_harmonic_injection} presented an uncomplicated way of adding the third harmonic: 
\begin{equation}
	t_h = \frac{1}{6}\cdot \sin{(3\cdot \arcsin{(\frac{a}{\sqrt{d^2+q^2}})}})
\end{equation}
Where $t_h$ is the portion of the third harmonic that needs to be added to each phase, d and q are from the Clarke Park transform and a is phase a.

\clearpage